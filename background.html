<!-- HTML header for doxygen 1.8.16-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SuPReMo: Background</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="rtic.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SuPReMo
   &#160;<span id="projectnumber">0.1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Background </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md0">Nomenclature</a></li>
<li class="level1"><a href="#autotoc_md1">Unifying image registration and respiratory motion modelling</a><ul><li class="level2"><a href="#autotoc_md2">Correspondence model</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md3">Algorithm</a><ul><li class="level2"><a href="#autotoc_md4">Computation of objective function</a></li>
<li class="level2"><a href="#autotoc_md5">Gradient calculation of objective function</a><ul><li class="level3"><a href="#autotoc_md6">Derivative: Regularisation with respect to the motion parameters</a></li>
<li class="level3"><a href="#autotoc_md7">Derivative: Similarity with respect to the simulated motion image</a></li>
<li class="level3"><a href="#autotoc_md8">Image acquisition and its adjoint</a></li>
<li class="level3"><a href="#autotoc_md9">Derivative: Transformed reference state image with respect to motion parameters</a></li>
<li class="level3"><a href="#autotoc_md10">Derivative: Motion parameters wirth respect ot model parameters</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p ><a class="anchor" id="md_motion_docu_Background"></a> The theoretical background is explained in the paper by <a href="https://doi.org/10.1088/1361-6560/aa6070">Jamie McClelland et al.</a>. Some more specifics which are relevant to the implementation of SuPReMo are provided on this page.</p>
<h1><a class="anchor" id="autotoc_md0"></a>
Nomenclature</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Symbol   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( \mathbf{I}_{t},\;t\in [1,\ldots, N_i] \)   </td><td class="markdownTableBodyNone">motion images (or dynamic images, in image space)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">\( t \)   </td><td class="markdownTableBodyNone">time point    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( N_i \)   </td><td class="markdownTableBodyNone">total number of motion images    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">\( \mathbf{I}_0 \)   </td><td class="markdownTableBodyNone">reference state image    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( \mathbf{M}_t = [m_{t,1}, \ldots, m_{t,N_m}]^\mathrm{T} \)   </td><td class="markdownTableBodyNone">motion parameters    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">\( N_m \)   </td><td class="markdownTableBodyNone">number of motion parameters    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( \mathbf{S}_t = [s_{t,1}, \ldots, s_{t,N_s} ]^\mathrm{T} \)   </td><td class="markdownTableBodyNone">surrogate signal    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">\( N_s \)   </td><td class="markdownTableBodyNone">number of surrogate signals per time point    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( \mathbf{R}=[\mathbf{R}_1,\ldots,\mathbf{R}_{N_r}]^\mathrm{T} \)   </td><td class="markdownTableBodyNone">model parameters    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">\( N_r \)   </td><td class="markdownTableBodyNone">number of model parameters per motion parameter    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( \mathbf{P}_{\negthickspace A_t} \)   </td><td class="markdownTableBodyNone">simulated motion image (in acquisition space)    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">\( \mathbf{P}_{\negthickspace t}\)   </td><td class="markdownTableBodyNone">motion image (in acquisition space)    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">\( N_{p} \)   </td><td class="markdownTableBodyNone">number of voxels of the simulated dynamic image   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md1"></a>
Unifying image registration and respiratory motion modelling</h1>
<p >The unified framework directly optimises the correspondence model parameters \(\mathbf{R}\) on all motion images simultaneously.</p>
<p ><a class="anchor" id="ObjectiveFunction"></a> </p><p class="formulaDsp">
\[
\mathcal{C}_t = (1-\lambda) \mathcal{S}( \mathbf{P}_{\negthickspace t}, A_t(\mathbf{T}(\mathbf{I}, \mathbf{M}_t)))
+ \lambda\mathcal{R}(\mathbf{M}_t)
\]
</p>
<p >Often the image similarity and regularisation are weighted with a parameter \(\lambda \in ]0,1]\), such that a balance between data fidelity and smoothness of the solution can be controlled.</p>
<p >In order to make use of gradient based optimisation methods, the partial derivative of the cost function \(\mathcal{C}\) needs to be known with respect to those model parameters. <a class="anchor" id="DerivOfObjectiveFunctionWRTModelParams"></a> </p><p class="formulaDsp">
\[
\frac{\partial\mathcal{C}_t}{\partial \mathbf{R}} 
= 
\frac{\partial \mathbf{M}_t}{\partial\mathbf{R}}
\frac{\partial\mathcal{C}_t}{\partial\mathbf{M}_t}
\]
</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Correspondence model</h2>
<p >The correspondence model relates the surrogate signal and the model parameters with the motion parameters, i.e.  </p><p class="formulaDsp">
\[
\mathbf{M}_t = F(\mathbf{S}_t,\mathbf{R}).
\]
</p>
<p> For instance a 2nd order polynomial model can be expressed as <a class="anchor" id="correspondenceModelQuadratic"></a> </p><p class="formulaDsp">
\[
\mathbf{M}_t = \mathbf{R}_1 s_t^2 +\mathbf{R}_2 s_t + \mathbf{R}_3
\]
</p>
<p> with the corresponding partial derivatives  </p><p class="formulaDsp">
\begin{eqnarray*}
\frac{\partial \mathbf{M}_t}{\partial \mathbf{R}_1} = s_t^2, \;\;
\frac{\partial \mathbf{M}_t}{\partial \mathbf{R}_2} = s_t, \;\;
\frac{\partial \mathbf{M}_t}{\partial \mathbf{R}_3} = 1.
\end{eqnarray*}
</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Algorithm</h1>
<h2><a class="anchor" id="autotoc_md4"></a>
Computation of objective function</h2>
<p >The objective function value for a single motion-image time point is computed on the basis of <a class="el" href="background.html#ObjectiveFunction">the objective function</a>. The total objective function value is the sum over all time points <a class="anchor" id="CostFuncSummedOverAllTimePoints"></a> </p><p class="formulaDsp">
\[
\mathcal{C}_\text{total} = \sum_{t=1}^{N_i} \mathcal{C}_t.
\]
</p>
<p >A procedural description of how the objective function value is calculated is presented in listing... </p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000002">Todo:</a></b></dt><dd>Insert pseudo code for objective function claculation in documentation</dd></dl>
<h2><a class="anchor" id="autotoc_md5"></a>
Gradient calculation of objective function</h2>
<p >Here, first the gradient of the total cost function is calculated by expansion of <a class="el" href="background.html#DerivOfObjectiveFunctionWRTModelParams">the derivative of the cost function with respect to the model parameters</a> and <a class="el" href="background.html#CostFuncSummedOverAllTimePoints">the cost function summed over all time points</a> The total gradient is given by</p>
<p class="formulaDsp">
\begin{align}
\frac{\partial \mathcal{C}_\text{total}}{\partial \mathbf{R}} 
&amp; = \sum_{t=1}^{N_i}
\frac{\partial \mathcal{C}_t}{\partial \mathbf{R}} \\
&amp; = \sum_{t=1}^{N_i} \frac{\partial \mathbf{M}_t}{\partial\mathbf{R}}
\frac{\partial\mathcal{C}_t}{\partial\mathbf{M}_t}.
    \end{align}
</p>
<p> Substituting \(\frac{\partial\mathcal{C}_t}{\partial \mathbf{M}_t}\) with <a class="el" href="background.html#ObjectiveFunction">the objective function</a> yields  </p><p class="formulaDsp">
\begin{align}
    \frac{\partial \mathcal{C}_\text{total}}{\partial \mathbf{R}} 
&amp; = \sum_{t=1}^{N_i} 
\frac{\partial \mathbf{M}_t}{\partial\mathbf{R}}
\left( (1-\lambda)
       \frac{\partial \mathcal{S}_t}{\partial\mathbf{M}_t} + 
       \lambda
       \frac{\partial \mathcal{R}_t}{\partial\mathbf{M}_t} \right).
    \end{align}
</p>
<p >Again, using the chain-rule to substitute \(\frac{\partial \mathcal{S}_t}{\partial\mathbf{M}_t}\),  </p><p class="formulaDsp">
\begin{align}
    \frac{\partial \mathcal{C}_\text{total}}{\partial \mathbf{R}} 
&amp; = \sum_{t=1}^{N_i} 
\frac{ \partial \mathbf{M}_t}{\partial\mathbf{R} }
\left( (1-\lambda) \frac{\partial \mathbf{I}_{T_t}}{\partial\mathbf{M}_t}\frac{\partial \mathcal{S}_t}{\partial\mathbf{I}_{T_t}} + \lambda
       \frac{\partial \mathcal{R}_t}{\partial\mathbf{M}_t} \right)\\
&amp; = \sum_{t=1}^{N_i} 
\frac{ \partial \mathbf{M}_t}{\partial\mathbf{R} }
\left( 
(1-\lambda)
\frac{\partial \mathbf{I}_{T_t}}{\partial\mathbf{M}_t}
\frac{\partial \mathbf{P}_{\negthickspace A_t}}{\partial \mathbf{I}_{T_t}}
\frac{\partial \mathcal{S}_t}{\partial\mathbf{P}_{\negthickspace A_t}}  +
\lambda 
\frac{\partial \mathcal{R}_t}{\partial\mathbf{M}_t} \right)\\
&amp; = \sum_{t=1}^{N_i} 
\frac{ \partial \mathbf{M}_t}{\partial\mathbf{R} }
\left( (1-\lambda) \frac{\partial \mathbf{I}_{T_t}}{\partial\mathbf{M}_t}
       A^*_t \left( \frac{\partial \mathcal{S}_t}{\partial\mathbf{P}_{\negthickspace A_t}} \right) 
+\lambda 
\frac{\partial \mathcal{R}_t}{\partial\mathbf{M}_t} \right).
\end{align}
</p>
<p >In the next section the different elements of the derivative required for gradient-based optimisation are described in more detail.</p>
<h3><a class="anchor" id="autotoc_md6"></a>
Derivative: Regularisation with respect to the motion parameters</h3>
<p >This term \(\frac{\partial \mathcal{R}_t}{\partial\mathbf{M}_t}\) is well known from image registration and any existing implementation can be utilised here. Popular regularisation methods include for instance bending energy, linear elastic potential, and determinant of the Jacobian.</p>
<h3><a class="anchor" id="autotoc_md7"></a>
Derivative: Similarity with respect to the simulated motion image</h3>
<p ><a class="anchor" id="DerivSimWRTPartialImageData"></a> </p><p class="formulaDsp">
\[
\frac{\partial \mathcal{S}_t}{\partial\mathbf{P}_{\negthickspace A_t}}
=
\left[ 
\frac{\partial \mathcal{S}_t}{\partial p_{A_t,1}},
\ldots,
\frac{\partial \mathcal{S}_t}{\partial p_{A_t,N_p}}
\right]^\mathrm{T}
\]
</p>
<p> is a column vector of size \(N_p \times 1\), where \(N_p\) is the number of voxels in the simulated motion image \(\mathbf{P}_{\negthickspace A_t}\). Each element of this vector is the gradient of the similarity measure with respect to that voxel (i.e. image intensity).</p>
<p >If \(\mathcal{S}\) measures similarity between the motion image and the simulated motion image in terms of the sum of squared differences as  </p><p class="formulaDsp">
\[
\mathcal{S}_\text{SSD} = \sum_{\mathbf{x\in\Omega}}\left(\mathbf{P}_{\negthickspace t}(\mathbf{x}) - \mathbf{P}_{\negthickspace A_t}(\mathbf{x})\right)^2,
\]
</p>
<p> then the derivative with respect to the simulated motion image intensity for each voxel is given by  </p><p class="formulaDsp">
\[
 \frac{\partial \mathcal{S}}{\partial p_{A_t,y}}
    = -2\left(p_{A_t,y} - p_{t,y}\right).
\]
</p>
<h3><a class="anchor" id="autotoc_md8"></a>
Image acquisition and its adjoint</h3>
<p ><a class="el" href="background.html#DerivSimWRTPartialImageData">The derivative of the image similarity with respect to the partial image data</a> measures the gradient direction in the space of the raw (or partial, or unsorted) image data. In order transform this into the space of the full, reconstructed image space, the adjoint of the image acquisition function \(A\) may be used.</p>
<p >The image acquisition process can be described by a time-dependent function \(A_t\), which maps the unknown underlying image \(\mathbf{I}_t\) &ndash; or the transformed reference state image \(\mathbf{I}_{T_t}\) into the acquisition space. <a class="anchor" id="simulationOfImageAcquisition"></a> </p><p class="formulaDsp">
\[
\mathbf{P}_{\negthickspace t} = A_t(\mathbf{I}_t) + \varepsilon_t
\]
</p>
<p> As a consequence, the image acquisition \(A_t\) can be expressed as an \(N_p \times N_v\) matrix  </p><p class="formulaDsp">
\[
A_t = 
\begin{pmatrix}
a_{t,1,1} &amp; \ldots &amp; a_{t,1,N_v} \\
\vdots &amp; \ddots &amp; \vdots \\
a_{t,N_p,1} &amp; \ldots &amp; a_{t,N_p,N_v}
\end{pmatrix}
\]
</p>
<p> where each element \(a_{t,i,j}\) is the contribution of voxel \(j\) in the transformed reference state image to the partial image data voxel at position \(i\).  </p><p class="formulaDsp">
\[
a_{t,i,j} = \frac{\partial p_{A_t,i}}{\partial i_{T_t,j}}
\]
</p>
<p >Using the hermitian adjoint, i.e. complex conjugate, \(A^*_t = \left(\bar{A_t}\right)^\mathrm{T}\), the similarity difference measured in the partial image space can be mapped back to full image space. Consequently, \(A_t^*\) is of size \(N_v\times N_p\) when written in matrix form.</p>
<p ><a class="anchor" id="adjointAsDerivative"></a> </p><p class="formulaDsp">
\[
A_t^* = \frac{\partial \mathbf{P}_{\negthickspace A_t}}{\partial \mathbf{I}_{T_t}}
\]
</p>
<p> Note, appropriate masking is required in the implementation of this mapping, depending on the reach of the partial image data on the full image data.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
Derivative: Transformed reference state image with respect to motion parameters</h3>
<p >This derivative , \(\frac{\partial \mathbf{I}_{T_t}}{\partial\mathbf{M}_t}\) gives the changes of the intensity of the transformed reference image with respect to the motion parameters and is thus dependent on the transformation model used. In the special case of non-parametric registration, this is given by the warped spatial image gradient.</p>
<p >Hence, the derivative given in matrix notation is of size \(N_m \times N_v\).  </p><p class="formulaDsp">
\[
\frac{\partial \mathbf{I}_{T_t}}{\partial \mathbf{M}_t} 
= \begin{pmatrix}
\frac{\partial i_{T_t,1}}{\partial m_{t,1}}
&amp; \ldots &amp; \frac{\partial i_{T_t,N_v}}{\partial m_{t,1}}\\
\vdots &amp; \ddots &amp; \vdots \\
\frac{\partial i_{T_t,1}}{\partial m_{t,N_m}} &amp; \ldots &amp; 
\frac{\partial i_{T_t,N_v}}{\partial m_{t,N_m}}
\end{pmatrix}
\]
</p>
<p> Note that \(N_m\) is the number of motion parameters which, in case of a parametric transformation is the product of the number of motion parameters (e.g. control points for a B-spline transformation), and in case of a non-parametric transformation the number of deformation vectors times the number of dimensions.</p>
<p >In case of a parametric transformation, such as a B-spline transformation, the chain rule is applied once more <a class="anchor" id="imageGradWRTMotionParameters"></a> </p><p class="formulaDsp">
\[
\frac{\partial \mathbf{I_{T_t}}}{\partial \mathbf{M}_t} 
=
\frac{\partial \textbf{DVF}_t}{\partial \mathbf{M_t}}
\frac{\partial \mathbf{I}_{T_t}}{\partial \textbf{DVF}_t}.
\]
</p>
<p> which means for each matrix entry  </p><p class="formulaDsp">
\[
\frac{\partial i_{T_t,j}}{\partial m_{t,i}}
= 
\frac{\partial i_{T_t,j}}{\partial \textit{dvf}_{t,x}}
\frac{\partial \textit{dvf}_{t,x}}{\partial m_{t,i}}.
\]
</p>
<p> This is the multiplication of the warped image gradient with the contribution of each control point to the transformation at a given position \(x\). The latter one can be calculated by convolving the deformation vector field with the B-spline base function and sampling accordingly.</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Derivative: Motion parameters wirth respect ot model parameters</h3>
<p >The <a class="el" href="background.html#correspondenceModelQuadratic">quadratic correspondence model</a> can be generalised for any polynomial function as <a class="anchor" id="correspondenceModelPolynomial"></a> </p><p class="formulaDsp">
\[
\mathbf{M}_t = \sum_{i=1}^{N_s} \mathbf{R}_i s_{i,t}
\]
</p>
<p> with the corresponding partial derivative with respect to the model parameters <a class="anchor" id="partialMotionWRTModel"></a> </p><p class="formulaDsp">
\[
\frac{\partial\mathbf{M}_t}{\partial\mathbf{R}_i} = s_{i,t}.
\]
</p>
<p> In matrix notation <a class="el" href="background.html#partialMotionWRTModel">the above equation</a> can be written as a vertical stack of diagonal matrices:  </p><p class="formulaDsp">
\[
\frac{\partial \mathbf{M}_t}{\partial\mathbf{R}}
=\begin{pmatrix}
\frac{\partial\mathbf{M}_t}{\partial\mathbf{R}_1}\\
\frac{\partial\mathbf{M}_t}{\partial\mathbf{R}_2}\\
\vdots\\
\frac{\partial\mathbf{M}_t}{\partial\mathbf{R}_{N_s}}
\end{pmatrix}
=
\begin{pmatrix}
s_{1,t} \\
&amp;\ddots\\
&amp;&amp;s_{1,t}\\
&amp;\vdots\\
s_{N_{s},t} \\
&amp;\ddots\\
&amp;&amp;s_{N_{s},t}\\
\end{pmatrix}
\]
</p>
<p >This matrix is of size \(N_r \times N_m\) and completes the collection of partial derivatives required for the gradient calculation. A summary of the complete procedure how to compute the gradient is presented in listing ...</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>Include pseudo code for objective function gradient calculation. </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.16-->
<!-- start footer part -->
<div class="footer">
  <span class="credits">
    <a href="https://www.ucl.ac.uk/medical-physics-biomedical-engineering/research/research-groups/radiotherapy-image-computing-group-rtic" target="_blank">The Radiotherapy Image Computing Group,</a>
    doxygen 
    <a href="https://github.com/ZenCPP/zen-doxygen-theme" target="_blank">Zen theme</a>
    made by
    <a href="https://github.com/samvv/" target="_blank">Sam Vervaeck</a>
 </span>
  <hr class="footer"/>
  <address class="footer">
    Generated by &#160;
    <a href="http://www.doxygen.org/index.html">
      <img class="footer" src="doxygen.png" alt="doxygen"/>
    </a> 1.9.5
  </address>
</div>
</body>
</html>
